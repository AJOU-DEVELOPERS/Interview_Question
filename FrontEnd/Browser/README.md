> # 브라우저 동작원리

### 브라우저의 주요 기능

사용자가 선택한 자원(HTML)을 서버에 요청하고 브라우저에 표시하는 것

---

### 브라우저 구성 요소

1. 사용자 인터페이스 - 요청한 페이지를 보여주는 창을 제외한 나머지 모든 부분
2. 브라우저 엔진 - 사용자 인터페이스와 렌더링 엔진 사이의 동작을 제어
3. 렌더링 엔진 - 요청한 콘텐츠를 표시  (HTML을 요청하면 HTML과 CSS를 파싱하여 화면에 표시)
4. 통신 - HTTP 요청과 같은 네트워크 호출에 사용됨.
5. UI 백엔드
6. 자바스크립트 해석기 - 자바스크립트 코드를 해석하고 실행
7. 자료 저장소 - 자료를 저장하는 계층, 모든 종류의 자원을 하드 디스크에 저장한다.

---

### 렌더링 엔진 동작 과정

![](https://images.velog.io/images/jinpro/post/d232cbbc-1c5a-4cc4-800f-1772feee7fed/helloworld-59361-2.png)


통신으로부터 요청한 문서의 내용을 얻는 것으로 시작한다.
문서 내용은 보통 8KB 단위로 전송된다.

렌더링 엔진은 HTML문서를 파싱하고 "콘텐츠 트리" 내부에서 태그를 DOM 노드로 변환한다.

외부 CSS 파일같은 스타일 요소도 파싱한다.

스타일 정보와 HTML 표시 규칙은 "렌더 트리"라고 부르는 트리를 생성한다.

렌더 트리 생성이 끝나면 UI백엔드에서 렌더 트리의 각 노드들의 형상을 화면의 정확한 위치에 만들어 낸다.

**일련의 과정들이 점진적**으로 진행된다.

즉, 네트워크로부터 나머지 내용을 전송받을때까지 기다리지 않고, 받은 내용의 일부를 먼저 화면에 표시한다.

![](https://images.velog.io/images/jinpro/post/c02b75fa-8d02-4c0f-b3ee-3936fbbcacf5/helloworld-59361-3.png)

즉,

1. HTML 마크업을 처리하고 DOM 트리를 빌드한다. ("무엇을" 그릴지 결정한다.)
2. CSS 마크업을 처리하고 CSSOM 트리를 빌드한다. ("어떻게" 그릴지 결정한다.)
3. DOM 및 CSSOM 을 결합하여 렌더링 트리를 형성한다. ("화면에 그려질 것만" 결정)
4. 렌더링 트리에서 레이아웃을 실행하여 각 노드의 기하학적 형태를 계산한다. ("Box-Model" 을 생성한다.)
5. 개별 노드를 화면에 페인트한다.(or 래스터화)

---

### 파싱

> 파싱이란, 브라우저가 코드를 이해하고 사용할 수 있는 구조로 변환하는 것
> 토큰이란, 유효하게 구성된 단위의 집합체 ( === 사전 )

- 어휘 분석 => 토큰화
  - 의미 없는 문자(공백과 줄바꿈) 제거
  - 자료를 토큰으로 분해하는 과정

- 구문 분석 => 트리 구축
  - 언어의 구문 규칙을 적용하여 파싱 트리 생성


1. 어휘 분석기로 자료를 토큰화한다.
2. 토큰이 구뮨 규칙과 일치하는지 확인
3. 일치하면, 파싱 트리에 추가
4. 일치하지 않으면, 파서는 토큰을 내부적으로 저장

위 과정은 반복된다.

위 파싱 과정으로 HTML 파싱을 할 수 없다.

- HTML 언어의 너그러운 속성
- HTML 오류에 대한 브라우저의 관용
- 소스는 파싱하는 동안 변하지 않지만 HTML에서 document.write를 포함하고 있는 스크립트 태그는 토큰을 추가할 수 있기 때문에 파싱이 수정된다.

---

### HTML 파싱

![](https://images.velog.io/images/jinpro/post/61b9fa4e-6a2d-4641-b8fb-72851515091a/image.png)

HTML에서 토큰 종류
- 시작 태그
- 종료 태그
- 속성 이름
- 속성 값

HTML 파싱과정에서 HTML 토큰 종류에 따른 상태를 가지고 있고, 상태에 따라 같은 문자를 읽어도 다른 결과물을 갖는다.

예를들어, 문자 d를 읽었을때 속성 값의 d 인지 div 태그의 d인지 상태에 따라 다르다.

HTML에서 CSS, js, 이미지에 대한 링크 정보를 추출한다. 추출한 정보의 URL을 이용 새로운 요청을 보낸다.
    
---

### 스크립트와 스타일 시트의 진행 순서

#### 스크립트

웹은 파싱과 실행이 동시에 수행되는 동기화 모델이다.
파서가 ```<script>``` 태그를 만나면 즉시 파싱하고 실행하기를 기대한다.
스크립트가 실행되는 동안 문서의 파싱은 중단된다.
스크립트가 외부에 있는 경우 우선 네트워크로부터 자원을 가져와야 하는데 이 또한 실시간으로 처리되고 자원을 받을 때까지 파싱은 중단된다.

스크립트를 defer(지연) 으로 표시할 수 있는데, 표시하면 문서 파싱은 중단되지 않고 문서 파싱이 완료된 이후에 스크립트가 실행된다.



#### 스타일 시트

이론적으로 스타일 시트는 **DOM 트리를 변경하지 않기 때문에** 문서 파싱을 기다리거나 중단할 이유가 없다. 그러나 스크립트 문서를 파싱하는 동안 스타일 정보를 요청하는 경우라면 문제가 된다.

스타일이 파싱되지 않은 상태라면 스크립트는 잘못된 결과를 내놓기 때문에 많은 문제를 야기한다.

즉, 스타일 시트를 먼저 파싱한 이후에 스크립트 파일을 파싱한다.

---

### 렌더 트리 구축

DOM 트리가 구축되는 동안 브라우저는 렌더트리를 구축한다.

DOM 트리와 렌더 트리는 1:1 대응 관계가 아니다.
예를들어, head 요소, display : none 값이 할당된 트리에 나타나지 않는다.

또한, float 처리된 요소나 position값이 적용된 요소는 트리의 다른곳에 배치된 상태로 그려진다.

---

### 특정 페이지를 표시할 때까지 서버에 요청하고 받는 전체 과정

1. URL 입력 엔터
2. 웹 브라우저가 URL 해석
3. URL이 문법에 맞으면 url의 host 부분에 encoding을 적용한다.
4. HSTS 목록을 로드해서 확인한다.
  - 목록에 존재하면 HTTPS
  - 존재하지 않으면 HTTP
5. DNS 조회한다.
  - Browser에 해당 Domain이 cache 되어있는지 확인한다.
  - 없으면 local에 저장된 hosts 파일에서 참조할 수 있는 Domain이 있는지 확인한다.
  - 위 두 가지 방법이 실패하면 DNS로 요청을 보낸다.
6. ARP로 대상의 IP와 MAC address를 알아낸다.
  - ARP broadcast를 보내기 위해
7. 대상과 TCP 통신을 통해 Socket을 연다.
8. HTTPS인 경우 TLS handshake가 추가된다.
9. HTTP 프로토콜 요청
10. HTTP 서버 응답
11. HTML,CSS,JS 파싱하여 렌더 트리 구축
12. 그리기

---

### 페이지 로딩 속도 줄이는 방법

- 성능 최적화 된 호스팅 사용
- 이미지 압축하고 최적화
- 리다이렉션 줄이기
- 웹 페이지 캐시
- 브라우저 캐시
- CSS 및 JS 파일에 비동기 및 지연로드를 사용
- CSS, JS , HTML 파일 축소
- CDN 사용
- 불필요한 플러그인 제거

---

### 페이지 로딩에 가장 영향을 주는 요소들을 일반화해보고 정리

- DOM에 접근
<내용추가>

---

### HTTP 요청을 보내서 페이지 하나를 로딩할 때까지 과정을 기술적인 용어로 설명

위 9번 부터 과정 자세히 설명
<내용추가>

---

### 로컬에 캐싱되는 경우는 개발자 도구에서 어떻게 표시되는 지 확인

![](https://images.velog.io/images/jinpro/post/59ef2d63-a49b-43fd-b245-d5bd7492849d/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-11-29%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%203.45.00.png)
<이거맞나>

---

### 최적화

<내용추가>

---

###  Browser 렌더링.
- https://www.edwith.org/ 접속시 브라우저에는 어떤 일들이 일어나는가?
  - www.edwith.org 라는 html 파싱
  - css, js, 이미지 정보 추출
  - html 파싱하면서 dom 트리 구축
  - css 파싱
  - 렌더 트리 구축
  - script파일 파싱
  - image 파일 파싱
